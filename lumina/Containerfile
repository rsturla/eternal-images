ARG BASE_IMAGE=ghcr.io/rsturla/eternal-linux/main/silverblue
ARG BASE_TAG=38
ARG FEDORA_VERSION=${BASE_TAG}

FROM ${BASE_IMAGE}:${BASE_TAG}

COPY files/etc/yum.repos.d /etc/yum.repos.d
COPY files/usr /usr

# Configure Just
RUN echo "!include /usr/share/eternal/lumina.just" >> /usr/share/eternal/justfile && \
  echo "!include /usr/share/eternal/lumina-setup.just" >> /usr/share/eternal/justfile

# Configure Gnome Shell Extensions and themes
RUN rpm-ostree install \
    gnome-shell-extension-appindicator \
    gnome-shell-extension-dash-to-dock \
    gnome-shell-extension-blur-my-shell \
    gnome-shell-extension-gsconnect \
    nautilus-gsconnect \
    yaru-theme \
    gnome-tweaks \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Remove unwanted packages
RUN rpm-ostree override remove \
    gnome-tour \
    gnome-extensions-app \
    gnome-system-monitor \
    yelp \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Configure dconf automated updates
RUN systemctl unmask dconf-update.service && \
  systemctl enable dconf-update.service \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Install Starship Shell Prompt
RUN curl -Lo /tmp/starship.tar.gz "https://github.com/starship/starship/releases/latest/download/starship-x86_64-unknown-linux-gnu.tar.gz" && \
  tar -xzf /tmp/starship.tar.gz -C /tmp && \
  install -c -m 0755 /tmp/starship /usr/bin \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Install Visual Studio Code
RUN rpm-ostree install \
    code \
  && \
  rm -f /etc/yum.repos.d/vscode.repo \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Install virt-manager
RUN rpm-ostree install \
    libvirt \
    virt-manager \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Install Docker
RUN rpm-ostree install \
  docker-ce \
  docker-ce-cli \
  containerd.io \
  docker-buildx-plugin \
  docker-compose-plugin \
  && \
  rm -f /etc/yum.repos.d/docker-ce.repo \
  && \
  systemctl enable docker.service \
  && \
  rm -rf /var/* /tmp/* && \
  ostree container commit

# Install DevPod
RUN rpm-ostree install https://github.com/loft-sh/devpod/releases/latest/download/DevPod_linux_x86_64.rpm && \
  curl -Lo /tmp/devpod https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64 && \
  install -c -m 0755 /tmp/devpod /usr/bin/devpod \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit

# Install additional CLI apps
COPY --from=cgr.dev/chainguard/ko:latest /usr/bin/ko /usr/bin/ko
COPY --from=cgr.dev/chainguard/kubectl:latest /usr/bin/kubectl /usr/bin/kubectl
RUN curl -Lo /tmp/kind "https://github.com/kubernetes-sigs/kind/releases/latest/download/kind-$(uname)-amd64" && \
  install -c -m 0755 /tmp/kind /usr/bin/kind \
  && \
  rpm-ostree install $(curl https://api.github.com/repos/charmbracelet/vhs/releases/latest | jq -r '.assets[] | select(.name| test(".*.x86_64.rpm$")).browser_download_url') && \
  curl -Lo /tmp/ttyd https://github.com/tsl0922/ttyd/releases/latest/download/ttyd.x86_64 && \
  install -c -m 0755 /tmp/ttyd /usr/bin/ttyd \
  && \
  rm -rf /tmp/* /var/* && \
  ostree container commit
