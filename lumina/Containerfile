ARG BASE_IMAGE=ghcr.io/rsturla/eternal-linux/main/silverblue
ARG BASE_TAG=39
ARG FEDORA_VERSION=${BASE_TAG}
ARG DESKTOP_ENVIRONMENT=silverblue


FROM golang:1.21 AS tc-redirect-tap-build

RUN git clone https://github.com/awslabs/tc-redirect-tap.git --depth 1 /tmp/tc-redirect-tap && \
  cd /tmp/tc-redirect-tap && \
  GOOS=linux GOARCH=amd64 go build -o bin/tc-redirect-tap-amd64 ./cmd/tc-redirect-tap


FROM ${BASE_IMAGE}:${BASE_TAG}

ARG FEDORA_VERSION
ARG DESKTOP_ENVIRONMENT

COPY files/_base/etc/yum.repos.d /etc/yum.repos.d
COPY files/_base/usr /usr
COPY files/_${DESKTOP_ENVIRONMENT}/usr /usr

COPY scripts/ /tmp/scripts/

RUN chmod +x /tmp/scripts/*.sh /tmp/scripts/*.sh /tmp/scripts/_${DESKTOP_ENVIRONMENT}/*.sh && \
  /tmp/scripts/install.sh --version ${FEDORA_VERSION} --desktop ${DESKTOP_ENVIRONMENT} && \
  rm -rf /tmp/* /var/* && \
  ostree container commit
