ARG BASE_IMAGE=silverblue
ARG BASE_REGISTRY=ghcr.io/rsturla/eternal-linux/main/${BASE_IMAGE}
ARG BASE_TAG=41
ARG FEDORA_VERSION=${BASE_TAG}


FROM ${BASE_REGISTRY}:${BASE_TAG} AS rootfs

ARG FEDORA_VERSION
ARG BASE_IMAGE

COPY files/_base /
COPY files/_${BASE_IMAGE} /
COPY scripts/ /tmp/scripts/

RUN chmod +x /tmp/scripts/*.sh /tmp/scripts/*.sh /tmp/scripts/_${BASE_IMAGE}/*.sh && \
  /tmp/scripts/setup.sh && \
  /tmp/scripts/cleanup.sh \
  && \
  bootc container lint

# This builder image can be anything as long as it has a new enough
# rpm-ostree.
FROM quay.io/fedora/fedora-bootc:rawhide AS builder
RUN --mount=type=bind,rw=true,src=.,dst=/buildcontext,bind-propagation=shared \
    --mount=from=rootfs,dst=/rootfs \
    rm -rf /buildcontext/out.oci && \
    ls -la / && \
    rpm-ostree experimental compose build-chunked-oci --bootc --format-version=1 \
           --rootfs=/rootfs --output /buildcontext/out.oci

# Finally, output the OCI archive back into our final container image. Here we
# can add labels and other metadata - note that no metadata was inherited from
# the source image - only the root filesystem!
FROM oci:./out.oci
# Need to reference builder here to force ordering. But since we have to run
# something anyway, we might as well cleanup after ourselves.
RUN --mount=type=bind,from=builder,src=.,target=/var/tmp \
    --mount=type=bind,rw=true,src=.,dst=/buildcontext,bind-propagation=shared \
    rm -rf /buildcontext/out.oci
