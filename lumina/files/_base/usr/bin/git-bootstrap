#!/usr/bin/env bash

set -euo pipefail

GIT_DIR=
WORKTREE=false
BASE_BRANCH=main

usage() {
    cat <<EOF
git-bootstrap

Usage: $0 [args] <directory>

Args:
--branch, -b    The base branch to use. Defaults to 'main'.
--worktree      Whether to use a worktree. Defaults to false.
--help, -h      Show this help message.
EOF
}

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --branch|-b)
            BASE_BRANCH="$2"
            shift
            ;;
        --worktree)
            WORKTREE=true
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        *)
            # Assign the last argument to GIT_DIR
            GIT_DIR="$1"
            ;;
    esac
    shift
done

if [[ -z "$GIT_DIR" ]]; then
    echo "No directory specified."
    usage
    exit 1
fi

if [[ -d "$GIT_DIR/.git" || -d "$GIT_DIR/.bare" ]]; then
    echo "Directory already contains a git repository."
    exit 1
fi

if [[ "$WORKTREE" = true ]]; then
    # Create a bare repository
    git init --bare --initial-branch="$BASE_BRANCH" "$GIT_DIR/.bare"
    # Set up gitdir file
    echo "gitdir: ./.bare" > "$GIT_DIR/.git"
    # Add a worktree
    git -C "$GIT_DIR" worktree add --orphan "./default/$BASE_BRANCH"

    # Convert the worktree's .git file to use relative paths
    WORKTREE_PATH="$GIT_DIR/default/$BASE_BRANCH"
    if [[ -f "$WORKTREE_PATH/.git" ]]; then
        relative_gitdir=$(git -C "$WORKTREE_PATH" rev-parse --path-format=relative --git-common-dir)
        worktree_name=$(basename "$(cat "$WORKTREE_PATH/.git" | cut -d' ' -f2)")
        echo "gitdir: ${relative_gitdir}/worktrees/${worktree_name}" > "$WORKTREE_PATH/.git"
    fi
else
    # Initialize a regular repository
    git init "$GIT_DIR" --initial-branch="$BASE_BRANCH"
fi
